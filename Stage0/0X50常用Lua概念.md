# 0X50 常用 Lua 概念

## 前置知识

* 0X4F 安装和运行 Lua

## 导入

接下来我们按照面向过程的思路介绍Lua语言。对于面向过程编程来说，有两个基本要素——变量和操作。

## 变量

“变量”的概念来源于数学上的“变量”。但是在实际上编程中一般所说的“变量”和数学中不同分支学科中的“变量”不完全一致。

> 纯函数式编程中理论上是“无变量”的。但是那些作为占位符的名称在数学上其实也是变量。

根据变量机制的实际实现方式，我们经常把“变量”类比为一些仓库。我们可以在其中存放一种名为“值”的东西，也可以在需要时从变量中复制所存储的值，或者用新的值覆盖原先保存的值。直观来说，整数，有理数，实数，列表这些东西都是值，而变量是用来保存这些值的东西。

> 之所要强调保存值，是因为面向过程编程中是讲“时序”的。任何不刻意保存的东西，都有可能随着时间的流逝而消失。

### 变量名

为了区别不同的仓库，我们可以给不同的仓库编号，命名。为了区别不同的变量，我们也可以给不同的变量编号命名。在Lua中，变量名必须是按照这样的规则生成的：

1. 以大小写字母或者下划线开头。
1. 由大小写字母，下划线或数字组成。
1. 不能与关键字重复。

附上一个Lua的关键字列表：

| ------ | ------ | -------- | ------ | ------ | ------ |
| and    | break  | do       | else   | elseif | end    |
| false  | for    | function | goto   | if     | in     |
| local  | nil    | not      | or     | repeat | return |
| then   | true   | until    | while  |        |        |

关键字不能作为变量名是因为这些关键字在Lua已经被赋予了其他用途。

> 在Lua变量命名中同一个字母的大写和小写算不同的字符，所以“And”和“and”是不同的。因此“And”可以作为变量名。

按照以上生成规则，理论上可以生成无限个变量名。因此如果你不考虑内存占用问题的话，理论上Lua中可以有无限个变量。

> 即便不是无限个变量名，限制变量名只能由20个字符组成，那我们也有$\sum ^{n=19}_{i=0}{(26+26+1)*(26+26+1+10)^i}-22$个可用的变量名。

不过需要注意的是，以上规则生成的仅仅是符合语法规则的变量名。除了语法规则我们还要遵守一些其他规则：

1. 有一些特殊变量名也有预先约定好的用途。这些特殊变量名我们后续会有所介绍。一般来说，这些特殊变量名不应当被用作其他用途。
1. 变量名应当尽量表达清楚它的作用。所以“wa_wkjic000xgo238hmone_cg”这种不明所以的变量名是不推荐使用的。不过在写一些简短的表达式的时候我们还是可以使用“y”，“x”，“i”，“pi”这类比较简短的变量名的。

### 读取和赋值

变量是仓库，所以最基本的操作就是读写变量。在Lua中所有出现变量名的地方，都认为是在读取变量中所存储的值——除非变量名出现在`=`左侧。

关于读取的例子：

```lua
-- 输出变量a中所存储的内容，而非输出字母“a”。
print(a)
-- 其实单独写一个变量名也表示读这个变量，但是读取后不做任何事。
-- 所以在脚本中一行单写一个变量名一般没有意义。
a
```

> 所有变量的默认值都是`nil`。因此访问一个从未被赋值过的变量，得到的就是`nil`。

关于赋值的例子：

```lua
-- 将数字12赋值给变量a。
a = 12
-- 将变量a的值赋予变量b。这里读取a变量，赋值给b变量。
b = a
-- 同时给多个变量赋值，按照顺序匹配。
-- 左边的第一个变量被赋予右边第一个表达式的值。
-- 剩下的变量和表达式继续依次匹配。
-- 多出来的值不会被使用。多出来的变量会被赋予`nil`值。
a,b,c = 'hello','goodbye','see you'
```

需要注意，读取变量不会改变变量的内容。但是赋值给变量的时候会改变变量的内容。

> 在Lua虚拟机中我们实际上没法真正“删除”一个变量。因为一个变量名始终是可用的。你读取任何变量名都不会报错。因此，我们给一个变量赋值`nil`，恢复它的初始状态，就相当于删除了这个变量。
>
> 仅仅从Lua虚拟机内部来看，赋值nil给变量这个动作往往可有可无。但是考虑到虚拟机本身的内存占用，我们有时候还是要主动删除一些已经用不着的变量来释放内存空间。

## 值

说到了变量就一定要说一下值。什么是“值”这个话题可以聊很久。不过我觉得面向过程编程的入门教程不应该在这么沉重的话题上绕圈子。所以我们简单处理一下。值就是用来往变量里存的东西。顺便值之间还能进行运算。所谓的运算就是用一两个值算一算得到一个值。Lua中有且只有以下8个值类别。

* nil 空值
* boolean 逻辑值
* number 数字
* string 字符串
* function 函数
* userdata 用户数据
* thread 线程
* table 表

以上所述的8个值类型中，每个类别内都包含至少一个值。这8个类别加起来就涵盖了Lua中所有的值。我们后边再针对每个类别详细介绍。

### 字面值

对于值来说，我们有时候也需要通过值的名字直接表示值。为了这个用途给值起的名字就是字面值。

比如表示空值的`nil`，表示逻辑值的`true`和`false`，表示数字的`1`，`2`，`32`等，表示字符串的各种用引号括起来的字符串（字符串的内容加上包括它的引号合起来算是字面值，但是这个字面值表示的值中没有两侧的引号）。

## 操作

“操作”就可以按照字面意思理解。任何以变量为对象的动作都可以称之为“操作”。比如把一个值存入某个变量是一个操作，把一个变量的值复制给另一个变量也是操作。这两种是非常简单的操作。编程中还会用到更复杂的操作。比如把A，B两个变量的值相加然后赋值给B（我们把送值进入变量的操作称为“赋值”）。

> 面向过程编程的时序性对于操作同样有影响。同样的操作集合按照不同的顺序排列就可能导致不同的结果。

有了名词和动词，我们就能组织出语句。在编程中，有了变量和操作，我们就能组织出程序。

尽管Lua允许我们写出不属于任何函数的操作，但是按照面向对象的一般要求来说，所有的操作都是要打包成函数的（而且最好所有函数也都关联到类上）。

考虑到在Lua中函数也是变量值的一种，所以实际上在Lua中所有操作本身也是值。你可以把代表操作的函数看作是一种特殊的值。作为特殊值的函数和整数值或者逻辑值之类的普通值的不同之处在于它可以被“执行”。而普通值只能被读写或者存储。

辨析执行和读写是一个很有意思的事情，但是我这里不具体展开。因为可能牵扯到自我指涉或者递归。这样会增加本文的阅读难度。因此这里我仅仅举例简单说明一下：

想象你去看一本书，书中讲了堂·吉诃德大战风车的故事。你仅仅是读了这个故事然后讲给别人，那么这个故事对你来说就是普通值。

接着再假想你读了一本菜谱，按照菜谱的步骤一步一步做了一道菜出来。这个时候你按照菜谱的指示行动，就相当于执行了菜谱。菜谱对你来说就是一种可以执行的特殊值。

当然，可以执行不等于必须执行。你也可以仅仅把菜谱背下来然后说给别人听——就像你对待普通值那样。

普通值不是必然可执行的。但是有一些被当作普通值的值其实本质上是可执行的。例如说，你也可以把自己当作堂·吉诃德，按照故事剧本找个风车大战一场。事实上，演戏就是把故事当作了一种可执行的值。编程中也可以做类似的事情。例如说你通过代码生成了一个文本文件，然后再把这个文本文件当作代码去执行。对于生成这个文本文件的程序来说，这个文本文件仅仅是个普通值（相当于对于写故事的人来说，故事就是一个普通值）。但是后边执行这个文本文件的时候，它就成了可执行的值（相当于对于演员来说，剧本就是可执行的特殊值）。而如果你让生成的文本文件替换原先生成它的程序继续生成文本文件，那就更神奇了（相当于你让一个演员演作家，在演戏的过程中他真的写了一个剧本出来而且还按照这个剧本设定继续演下去了）。

## 后续推荐

* 0X01 简介
